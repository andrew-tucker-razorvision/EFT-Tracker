#!/bin/sh

# Three-tier pre-push validation (AUTOMATIC)
# Strategy:
# 1. TIER 1 (ALWAYS): Quick Coolify plan check (~15-30s) - catches 80% of issues
# 2. TIER 2 (CONDITIONAL): Full validation if TypeScript changed (2-3 min)
# 3. TIER 3 (AUTOMATIC): Full Docker build if deployment-critical files changed (2-4 min)

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” Pre-push validation (3-tier checks)..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Get list of changed files
CHANGED_FILES=$(git diff --cached --name-only)

# ============================================================================
# TIER 1: Quick deployment checks (MANDATORY, ~15-30s)
# ============================================================================
echo "1ï¸âƒ£  Quick Coolify validation (Tier 1)..."
if ! bash scripts/test-coolify-build.sh --quick > /dev/null 2>&1; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âŒ Tier 1: Quick validation failed"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Run manually to see details:"
    echo "  bash scripts/test-coolify-build.sh --quick"
    echo ""
    exit 1
fi
echo "âœ… Tier 1 passed: Coolify plan validated"
echo ""

# ============================================================================
# TIER 2: TypeScript validation (CONDITIONAL, 2-3 min)
# ============================================================================
echo "2ï¸âƒ£  Checking for TypeScript changes (Tier 2)..."
if echo "$CHANGED_FILES" | grep -qE '\.(ts|tsx)$'; then
    echo "TypeScript files changed - running full validation..."
    echo ""

    timeout 300 npm run validate
    VALIDATE_EXIT=$?

    if [ $VALIDATE_EXIT -eq 124 ]; then
        echo ""
        echo "â±ï¸  Tier 2: Validation timeout (5 minutes)"
        echo "Push blocked. You can:"
        echo "  1. Wait and try again"
        echo "  2. Push with: git push --no-verify"
        echo ""
        exit 1
    elif [ $VALIDATE_EXIT -ne 0 ]; then
        echo ""
        echo "âŒ Tier 2: Validation failed - fix errors and try again"
        exit 1
    fi
    echo "âœ… Tier 2 passed: Full validation successful"
else
    echo "No TypeScript changes - skipping Tier 2"
    echo "(Full validation will run on GitHub CI)"
fi
echo ""

# ============================================================================
# TIER 3: Full Docker build (AUTOMATIC, 2-4 min)
# Runs automatically when deployment-critical files change
# ============================================================================
echo "3ï¸âƒ£  Checking for deployment-critical file changes (Tier 3)..."
if echo "$CHANGED_FILES" | grep -qE '(nixpacks\.toml|Dockerfile|\.dockerignore|package\.json|pnpm-lock\.yaml|next\.config\.ts)'; then
    echo "âš ï¸  Deployment-critical files changed - running full Docker build test..."
    echo "   This takes 2-4 minutes but prevents Coolify deployment failures."
    echo ""

    if ! bash scripts/test-coolify-build.sh; then
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Tier 3: Docker build failed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Fix the errors above before pushing to prevent Coolify deployment failure."
        exit 1
    fi
    echo "âœ… Tier 3 passed: Full Docker build successful"
else
    echo "No deployment-critical changes - skipping Tier 3"
    echo "(Run manually if needed: bash scripts/test-coolify-build.sh)"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… All pre-push checks passed"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Push proceeding - Coolify deployment should succeed âœ“"
echo ""
